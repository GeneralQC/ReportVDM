<!DOCTYPE >
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VDM Platform Main - Full Assistant</title>
    <!-- Load Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Chart.js for creating charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <!-- Load Chart.js Data Labels Plugin for showing values on bars -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <!-- Load Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <style>
        /* --- CORE AI THEME STYLES (Space/Neon Cyan Dark Theme) --- */
        
        /* ⭐️ NEW: Hide Scrollbar (Keep Scrolling Functional) ⭐️ */
        /* Webkit (Chrome, Safari, newer Edge) */
        ::-webkit-scrollbar {
            display: none;
            width: 0px;
        }

        html { } 
        body {
            font-family: 'Inter', sans-serif;
            color: #E2E8F0; 
            min-height: 100vh; 
            margin: 0;
            padding: 0; 
            /* ⭐️ KEY FIX: SIMPLIFY BACKGROUND TO UNIFORM COLOR ⭐️ */
            background-color: #1A202C; 
            
            /* Hide scrollbar visual for Firefox/IE/Edge but keep scrolling functional */
            overflow-y: scroll; /* Allow body scrolling */
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
            
            display: block; 
        }
        
        /* Header Text Glow Effect */
        .neon-cyan {
            color: #00FFFF;
            text-shadow: 0 0 5px rgba(0, 255, 255, 0.6); 
            letter-spacing: 2px;
        }
        .header-text-glow {
            animation: none; /* No pulsing in this minimal style */
        }

        /* Chart/Dashboard Styles */
        .dashboard-card {
            background-color: #2D3748; 
            border: 1px solid #4A5568; 
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
        }
        
        /* Styles for Collapse/Expand transition for Chart (REMOVED) */
        .collapse-transition {
            /* Now managed by scale-y and opacity classes in JS */
        }
        .collapsed {
            /* Now managed by scale-y and opacity classes in JS */
        }

        /* --- VDM Search Assistant Styles (ADJUSTED FOR GEMINI INPUT) --- */
        
        /* ⭐️ NEW GEMINI INPUT BAR STYLE ⭐️ */
        .gemini-input-style {
            background: #2D3748; /* Darker than body for contrast */
            color: #E2E8F0;
            border: none; 
            border-radius: 20px; /* Rounded pill shape */
            padding: 1rem 1.5rem; 
            flex: 1;
            font-size: 1rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4); 
            transition: all 0.3s ease;
            resize: none; /* Prevent manual resize */
            height: 56px; /* Initial fixed height */
            line-height: 1.25;
        }
        .gemini-input-style:focus {
            background: #374151;
            box-shadow: 0 4px 20px rgba(0, 255, 255, 0.1); 
            outline: none; 
        }
        
        /* Send Button - minimal */
        .chat-input button {
            transition: all 0.2s;
            background: transparent;
            color: #00FFFF; 
            border-radius: 50%;
            padding: 0.5rem; 
        }
        .chat-input button:hover {
            background: #00FFFF22;
            color: #FFFFFF;
        }

        .bot-message {
            background: #2D3748; /* Dark Gray for bot */
            color: #E2E8F0;
            border: 1px solid #4A5568;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            /* Add space for options */
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .user-message {
            background: #00A3A3; 
            color: #1A202C;
            font-weight: 500;
        }
        
        /* New: Styling for Chat Options */
        .chat-option-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 5px;
        }
        .chat-option-button {
            background-color: #00FFFF;
            color: #1A202C;
            padding: 6px 12px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
            text-align: center;
            border: none;
            flex: 1 1 auto; /* Allows buttons to grow/shrink but maintain min size */
            max-width: 100%; /* Ensure it wraps nicely */
            font-size: 0.875rem; /* text-sm */
        }
        .chat-option-button:hover {
            background-color: #fff;
            transform: translateY(-1px);
        }


        /* ⭐️ Chat Log Area - Flowing content ⭐️ */
        #main-chat-log {
            overflow-y: visible; 
            padding: 0 0 1rem 0; /* Add padding to the bottom */
            min-height: 200px; /* Ensure space on initial load */
        }
        
        /* Main Content Wrapper (Centered and Flexible) */
        #mainContent {
            display: block; 
            margin: 0 auto;
            max-width: 1200px;
            width: 100%;
            padding: 0 2.5rem; 
            padding-top: 80px; 
            padding-bottom: 120px; 
        }
        
        /* ⭐️ KEY: Hide chat content initially ⭐️ */
        .active-chat-content {
            display: none; 
        }
        /* ⭐️ END STARTING STATE ⭐️ */

        /* ⭐️ KEY FIX: Fixed Input Bar (Always at the bottom of the viewport) ⭐️ */
        #fixed-input-container {
            /* Managed by JS in Idle State */
            bottom: 0;
            left: 0;
            right: 0;
            background-color: #1A202C; 
            padding: 1rem 0;
            z-index: 30;
            background: linear-gradient(to top, #1A202C 50%, #1A202C00 100%);
        }
        .fixed-input-inner {
            background: #1A202C;
            padding: 0 2.5rem; /* Match main content horizontal padding */
        }

        
        /* Google Translate Styles (Keep) */
        .goog-te-banner-frame { display: none !important; }
        body { top: 0 !important; }
        
        /* ⭐️ NEW POPOVER STYLES ⭐️ */
        .popover-hidden {
            transform: scaleY(0) translateY(-10px);
            opacity: 0;
            pointer-events: none; /* Disable interaction when hidden */
        }
        .popover-visible {
            transform: scaleY(1) translateY(0);
            opacity: 1;
            pointer-events: auto; /* Enable interaction when visible */
        }
        .chart-popup-content {
            max-height: 450px;
            overflow-y: auto;
        }
        
        /* ⭐️ FIX: Ensure Chart Popover is above all elements ⭐️ */
        /* Note: For it to float truly above ALL elements, it should be a direct child of body (see HTML structure changes) */
        #chartSection {
            z-index: 9999 !important; /* Extremely high Z-index to ensure visibility */
            position: fixed; /* Use fixed positioning for absolute floating relative to viewport */
            right: 20px; /* Adjust right position slightly */
            top: 70px; /* Position below the fixed header */
        }


        /* ⭐️ NEW: Typing Indicator for Conversational Feel ⭐️ */
        @keyframes blink {
            50% { opacity: 0; }
        }
        .typing-indicator::after {
            content: '|';
            animation: blink 1s step-start infinite;
            display: inline-block;
        }
        /* Placeholder to reserve space while typing */
        .typing-indicator-placeholder {
            min-height: 1.5rem;
        }
    </style>
</head>

<body class="relative">
    
    <!-- ⭐️ 1. TOP NAVBAR (FIXED POSITION) ⭐️ -->
    <div id="top-bar" class="fixed top-0 left-0 right-0 h-16 bg-[#1A202C] border-b border-gray-700 shadow-lg z-20 flex items-center px-4 md:px-8">
        
        <!-- Left Side: VDM Logo/Title (Minimal) -->
        <div class="flex items-center space-x-4 flex-shrink-0">
            <h1 class="text-2xl font-extrabold neon-cyan uppercase">
                VDM | HUB
            </h1>
            <!-- ⭐️ MOVED: Copyright to Navbar (Visible in all states) ⭐️ -->
            <span class="text-gray-600 text-sm hidden sm:block">
                &copy; 2025 VDM Platform.
            </span>
        </div>

        <!-- Right Side: Menu Buttons (Operational Modules & Status) -->
        <!-- UPDATED: Reduced space-x to 2 on mobile, 4 on medium screens -->
        <nav class="flex space-x-2 md:space-x-4 items-center text-sm font-medium flex-shrink-0 ml-auto">
             <!-- ⭐️ MOVED: New Chat Button (Now before Reports) ⭐️ -->
             <!-- UPDATED: Reduced padding and explicitly hidden on mobile -->
            <button id="newChatButton" onclick="newChat()" 
                class="text-gray-300 hover:text-red-400 transition duration-200 p-1 md:p-2 rounded-lg border border-gray-700 hover:border-red-400 whitespace-nowrap hidden sm:inline-block active-chat-content">
                New Chat
            </button>
            
            <!-- Operational Modules (REPORTS) -->
            <!-- UPDATED: Use icon only on mobile, icon + text on md+ -->
            <a href="report.html" title="Reports" class="text-gray-300 hover:text-[#00FFFF] transition duration-200 p-1 md:p-2 rounded-lg border border-gray-700 hover:border-[#00FFFF] whitespace-nowrap flex items-center">
                <i class="fas fa-file-alt text-lg md:text-sm mr-0 md:mr-1"></i>
                <span class="hidden md:inline">Reports</span>
            </a>
            <!-- NEW: Support & Guides (SOLUTIONS) -->
            <!-- UPDATED: Use icon only on mobile, icon + text on md+ -->
            <a href="solutions.html" title="Support & Guides" class="text-gray-300 hover:text-[#00FFFF] transition duration-200 p-1 md:p-2 rounded-lg border border-gray-700 hover:border-[#00FFFF] whitespace-nowrap flex items-center">
                <i class="fas fa-book-open text-lg md:text-sm mr-0 md:mr-1"></i>
                <span class="hidden md:inline">Support & Guides</span>
            </a>
            
            <!-- NEW: Maintenance Link -->
            <a href="https://www.appsheet.com/start/5321e28e-6b24-4704-b097-28aac113e0b7?refresh=1&platform=desktop#appName=RecordCalibrationLoadcell-209674834&vss=H4sIAAAAAAAAA63PPQ_CIBAG4L_S3MwvYG0cjB-DGhdxuMI1IVJogKoN4b9L_Yibix15uTz3XoKrpts-orwAP6Xva0UjcEgCDmNPAriA2tnonRHABGyxe4U7ks6rqkajG49RO1utHapKkimTGfKZfcxIAXj6n-Tzt2SgFdmoW01-8ietuG-rfE9SCX45kBl0Q8TG0PPY4uRcstbJIZA6lsozVQ1Lu7j3aNXGqbKmRRMoPwCfwSVCyQEAAA==" 
                title="Maintenance" class="text-gray-300 hover:text-yellow-400 transition duration-200 p-1 md:p-2 rounded-lg border border-gray-700 hover:border-yellow-400 whitespace-nowrap flex items-center"
                target="_blank" rel="noopener noreferrer">
                <i class="fas fa-wrench text-lg md:text-sm mr-0 md:mr-1"></i>
                <span class="hidden md:inline">Maintenance</span>
            </a>

            
            <!-- ⭐️ CHART POPOVER CONTAINER BUTTON ⭐️ -->
            <div class="relative">
                <!-- Status Work Issue button -->
                <!-- UPDATED: Use icon only on mobile, icon + text on md+ -->
                <button id="statusChartButton" onclick="toggleChart()" title="Status Work Issue" class="text-gray-300 hover:text-[#00FFFF] transition duration-200 p-1 md:p-2 rounded-lg border border-gray-700 hover:border-[#00FFFF] whitespace-nowrap flex items-center">
                     <i class="fas fa-tasks text-lg md:text-sm mr-0 md:mr-1"></i>
                     <span class="hidden sm:inline">Status Work Issue</span>
                </button>
            </div>
            
            <!-- ⭐️ MOVED: Google Translate Position (After Status Work Issue) ⭐️ -->
            <!-- UPDATED: Hidden on mobile (hidden sm:block) -->
            <div id="google_translate_element" class="text-xs hidden sm:block"></div>
        </nav>
    </div>

    <!-- 2. MAIN CONTENT AREA (Scrollable, Centered) -->
    <div class="flex-grow"> 
        <main id="mainContent">
            
            <!-- ⭐️ Chat Log Area (Hidden initially) ⭐️ -->
            <div id="main-chat-log" class="mx-auto w-full max-w-4xl flex flex-col p-2 overflow-y-visible active-chat-content">
                <!-- Chat messages will be dynamically added here -->
            </div>
            
        </main>
        
        <!-- ⭐️ REMOVED: Page Footer is now removed as content moved to Navbar ⭐️ -->
        <!-- <footer class="mt-8 text-center text-gray-600 text-sm active-chat-content">
            &copy; 2025 VDM Platform. All systems operational.
        </footer> -->
    </div>
    
    <!-- ⭐️ 4. FIXED INPUT BAR (Trims the bottom of the page) ⭐️ -->
    <div id="fixed-input-container">
        <div class="mx-auto w-full max-w-4xl px-4">
            
            <!-- ⭐️ WELCOME TEXT LOCATION (Above the Prompt Bar) ⭐️ -->
            <header id="input-welcome-text" class="mb-8 text-center">
                <h1 class="text-3xl sm:text-4xl lg:text-5xl font-extrabold text-white text-center">
                    Hello, Oversea
                </h1>
                <p class="text-sm sm:text-lg text-gray-400 font-light mt-2 text-center">
                    I'm your VDM Search Assistant. How can I help you today?
                </p>
            </header>
            <!-- END NEW WELCOME TEXT LOCATION -->
            
            <!-- ⭐️ NEW INPUT FIELD (TEXTAREA) ⭐️ -->
            <div class="chat-input flex items-center bg-transparent pt-0 flex-shrink-0 relative">
                <textarea id="main-user-input"
                    class="gemini-input-style w-full pl-6 pr-16"
                    placeholder="Ask VDM Assistant anything..."
                    rows="1"
                    onkeypress="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); mainSendMessage(); }"
                    oninput="autoResizeTextarea(this)"></textarea>

                <button onclick="mainSendMessage()"
                    class="transition duration-300 absolute right-1 top-1/2 transform -translate-y-1/2">
                    <!-- Send Icon (Styled for Gemini look) -->
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M16 12a4 4 0 1 0-8 0 4 4 0 0 0 8 0zm2 0a6 6 0 1 1-12 0 6 6 0 0 1 12 0z"/></svg>
                </button>
            </div>
        </div>
    </div>

    <!-- ⭐️ CHART POPUP CONTENT - MOVED TO THE END OF BODY ⭐️ -->
    <div id="chartSection" class="absolute right-0 top-full mt-2 w-96 max-w-xs sm:max-w-md z-50 transform origin-top-right transition-all duration-300 popover-hidden bg-[#2D3748] rounded-xl shadow-2xl border border-[#00FFFF33] p-4 hidden">
         <h3 class="text-base font-semibold text-white mb-2 border-b border-gray-600 pb-1">Status Work Issue by Plant</h3>
         
         <div class="chart-popup-content">
             <!-- Data Loading Indicator and Error Message -->
             <div id="loading" class="text-center text-sm text-yellow-400 my-4">
                 <div class="animate-spin inline-block w-4 h-4 border-2 border-yellow-500 border-t-transparent rounded-full mr-1"></div>
                 Fetching data...
             </div>

             <div id="error-message" class="hidden text-center text-sm text-red-500 my-4 p-2 rounded-lg bg-red-900/50">
                 Error fetching data.
             </div>

             <div class="chart-container">
                 <canvas id="workStatusChart" style="max-height: 250px;"></canvas>
             </div>
         </div>
    </div>
    <!-- ⭐️ END CHART POPUP CONTENT ⭐️ -->
    

    <!-- START JAVASCRIPT FOR DATA FETCHING AND CHART RENDERING -->
    <script>
        // --- TEXTAREA AUTO-RESIZE FOR GEMINI INPUT STYLE ---
        function autoResizeTextarea(element) {
            // Reset height to collapse it and re-calculate scroll height
            element.style.height = 'auto'; 
            // Set height based on scrollHeight, up to a max (e.g., 5 rows for max 140px)
            const maxHeight = 140; 
            element.style.height = Math.min(element.scrollHeight, maxHeight) + 'px';
            
            // ⭐️ IMPORTANT: Recalculate scroll position after resizing ⭐️
            if (document.getElementById('main-chat-log').children.length > 0) {
                 window.scrollTo(0, document.body.scrollHeight);
            }
        }

        // --- ⭐️ GOOGLE TRANSLATE INITIALIZATION (ADJUSTED) ⭐️ ---
        function googleTranslateElementInit() {
            new google.translate.TranslateElement({
                pageLanguage: 'th' 
            }, 'google_translate_element');
        }
        
        // Function to handle the state change (Idle -> Active Chat)
        function setActiveChatState() {
            // 1. Hide Welcome Header (now inside input container)
            const welcomeHeader = document.getElementById('input-welcome-text'); 
            welcomeHeader.style.opacity = '0';
            setTimeout(() => { welcomeHeader.style.display = 'none'; }, 300); // Wait for transition

            // 2. Show Active Chat Content (Chart wrapper, chat log, New Chat button)
            document.querySelectorAll('.active-chat-content').forEach(el => {
                el.style.display = 'block';
            });
        }
        
        // ⭐️ NEW FUNCTION: Add initial greeting to chat log ⭐️
        function addActiveChatGreeting() {
             const chatLog = document.getElementById('main-chat-log');
             if (chatLog.children.length === 0) {
                 const welcomeMessage = document.createElement('div');
                 welcomeMessage.className = 'block w-full flex justify-start';
                 
                 const content = document.createElement('div');
                 // Styled to be prominent at the start of conversation
                 content.className = 'max-w-full md:max-w-[70%] p-3 rounded-xl mb-6 shadow-md text-xl font-bold text-white mr-auto';
                 content.innerHTML = "Hello, I'm your VDM Search Assistant. How can I help you today?"; 
                 
                 welcomeMessage.appendChild(content);
                 chatLog.appendChild(welcomeMessage);
             }
        }

        // Ensure chart starts collapsed
        document.addEventListener('DOMContentLoaded', () => {
             const chartSection = document.getElementById('chartSection');
             
             // ⭐️ KEY FIX: If chat is empty, set initial positioning for fixed input to center it ⭐️
             const chatLog = document.getElementById('main-chat-log');
             const inputContainer = document.getElementById('fixed-input-container');
             const welcomeHeader = document.getElementById('input-welcome-text'); 
             const newChatBtn = document.getElementById('newChatButton');
             
             if (chatLog.children.length === 0) {
                 // Idle state: center the input bar vertically on the screen
                 inputContainer.style.position = 'absolute';
                 inputContainer.style.top = '50%';
                 inputContainer.style.transform = 'translateY(-50%)';
                 inputContainer.style.padding = '0'; 
                 
                 // Hide active chat elements
                 document.querySelectorAll('.active-chat-content').forEach(el => {
                    el.style.display = 'none';
                 });
                 if (newChatBtn) {
                    newChatBtn.classList.add('hidden');
                 }
                 
                 // Ensure header is visible
                 welcomeHeader.style.display = 'block'; // Use block for flow control
                 
             } else {
                 // Active state: ensure fixed position and visible chat content
                 setActiveChatState();
                 if (newChatBtn) {
                    newChatBtn.classList.remove('hidden');
                 }
             }
             
             // Scroll the main window to the bottom on initial load to show prompt
             window.scrollTo(0, document.body.scrollHeight);
             
             // ⭐️ FIX: Ensure chart is hidden on initial load ⭐️
             if (chartSection) {
                chartSection.classList.add('hidden', 'popover-hidden');
             }
        });
        
        // Google Apps Script API URL provided by the user (Chart Data)
        const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbzDTO0biyndbrxLnJUb4yOORgYytoX1ZlANMNiZsM-RoexobcDMZP16un2PGZLDdnHmCA/exec';

        // --- VDM Search Assistant Globals (Solutions Data) ---
        const SOLUTIONS_API_URL = "https://script.google.com/macros/s/AKfycbw2lG6q5IjOf9jvZo7y1yGNUn-Y-8XRbG0jEgLCsCX9LZEC96luvk2G3pFPd4QHSUN2Uw/exec";
        let solutions = []; // Solutions data array

        // --- ⭐️ NEW REPORT TIMELINE GLOBALS ⭐️ ---
        const REPORT_API_URL = 'https://script.google.com/macros/s/AKfycbxZLUhugbl6GfvRTsVAJKXoUhpbnsHXOR-EpKN9W_eBR14fy7Iqmic9p9ptRHbYIpYNOA/exec';
        let timelineReports = []; // Report data array
        
        // ⭐️ UPDATED: Expanded REPORT_KEYWORDS list (FIXED: Added 'cáo' for Vietnamese) ⭐️
        const REPORT_KEYWORDS = [
            'report', 'รายงาน', 'timeline', 'เหตุการณ์', 'event', 'สรุป', 'summary', 'info',
            
            // Vietnamese
            'báo cáo', 'tổng kết', 'thời gian biểu', 'cáo', 'báo',
            
            // Burmese (Myanmar)
            'အစီရင်ခံစာ', 'အနှစ်ချုပ်', 'si yin hkan', 'si yin hkan sa',
            
            // Bengali (Bangladesh)
            'প্রতিবেদন', 'সংক্ষেপ', 'khobor', 'khabar',
            
            // Khmer (Cambodia)
            'របាយការណ៍', 'សង្ខេប', 'phsaiphu', 'karn',
            
            // Chinese
            '报告', '摘要', '汇报', 'huibao', 'baogao',
            
            // Filipino (Tagalog)
            'ulat', 'buod', 'balita', 'reporta', 'pahayag',
            
            // Lao
            'ບົດລາຍງານ', 'ສະຫຼຸບ', 'laingan', 'bot laing',
            
            // Hindi/Indian (Comprehensive)
            'रिपोर्ट', 'सारांश', 'विवरण', 'khabar', 'jaankaari', 'karyavahi',
        ];
        
        // Global state to track if we are in a report flow
        let isInReportFlow = false;
        
        // Register the DataLabels plugin globally
        Chart.register(ChartDataLabels);
        
        // ⭐️ REMOVED: The simulateNavigation function is now removed as links are handled by anchor tags ⭐️
        
        // ⭐️ NEW FUNCTION: Force transition to active chat state ⭐️
        function forceToActiveState() {
             const inputContainer = document.getElementById('fixed-input-container');
             const newChatBtn = document.getElementById('newChatButton');
             const chartSection = document.getElementById('chartSection');
             
             // 1. Transition Input Bar from Center Absolute to Fixed Bottom
             inputContainer.style.position = 'fixed';
             inputContainer.style.top = 'auto';
             inputContainer.style.bottom = '0';
             inputContainer.style.transform = 'none';
             inputContainer.style.padding = '1rem 0';
             inputContainer.style.transition = 'all 0.4s ease-in-out';
             
             // 2. Set Active Chat State
             setActiveChatState();
             
             // 3. Add greeting to the conversation log
             if (document.getElementById('main-chat-log').children.length === 0) {
                 addActiveChatGreeting();
             }

             // 4. Show New Chat button
             if (newChatBtn) {
                newChatBtn.classList.remove('hidden');
             }
             
             // ⭐️ FIX: Hide the chart section when entering active chat mode ⭐️
             if (chartSection.classList.contains('popover-visible')) {
                 toggleChart(); // Call toggle to hide it gracefully
             } else {
                 chartSection.classList.add('hidden', 'popover-hidden'); // Ensure it's hidden if not visible
             }
             
             // Remove transition after use to prevent conflicts
             setTimeout(() => { inputContainer.style.transition = 'none'; }, 500);
        }

        // New: Clear Chat History Function (kept from original)
        function newChat() {
            const chatLog = document.getElementById('main-chat-log');
            
            // Clear all children
            chatLog.innerHTML = '';
            
            // Reset report flow state
            isInReportFlow = false;
            
            // ⭐️ Revert to Idle State ⭐️
            const welcomeHeader = document.getElementById('input-welcome-text');
            const inputContainer = document.getElementById('fixed-input-container');
            const newChatBtn = document.getElementById('newChatButton');
            const chartSection = document.getElementById('chartSection');

            welcomeHeader.style.display = 'block'; // Use block to match HTML structure
            welcomeHeader.style.opacity = '1';

            document.querySelectorAll('.active-chat-content').forEach(el => {
                el.style.display = 'none';
            });
            
            // Hide New Chat button
            if (newChatBtn) {
                newChatBtn.classList.add('hidden');
            }
            
            // Ensure chart is hidden on reset
            if (chartSection) {
                 chartSection.classList.add('hidden', 'popover-hidden');
            }


            // Reset Input Bar to Center Absolute
            inputContainer.style.position = 'absolute';
            inputContainer.style.top = '50%';
            inputContainer.style.transform = 'translateY(-50%)';
            inputContainer.style.padding = '0';
            inputContainer.style.transition = 'none'; // Ensure no transition on reset

            // Reset textarea height and value
            const input = document.getElementById('main-user-input');
            input.value = '';
            autoResizeTextarea(input);

            // Scroll to the top to see the centered input
            window.scrollTo(0, 0);
        }
        window.newChat = newChat;
        
        // --- Helper functions for Exponential Backoff (API retry logic) (kept from original) ---
        const MAX_RETRIES = 3;
        const INITIAL_DELAY_MS = 1000;

        async function fetchWithRetry(url, options = {}, retries = 0) {
            try {
                const response = await fetch(url, options);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                // Check if the response is JSON
                const contentType = response.headers.get("content-type");
                if (contentType && contentType.indexOf("application/json") !== -1) {
                    return await response.json();
                } else {
                    // Assume plain text if not JSON, but for this app we expect JSON
                    const text = await response.text();
                    try {
                        // Attempt to parse text as JSON just in case
                        return JSON.parse(text);
                    } catch {
                        // If it fails, return the text, or throw error depending on expected format
                        // For the Report API, we MUST have an array.
                        throw new Error("API returned non-JSON data."); 
                    }
                }
            } catch (error) {
                if (retries < MAX_RETRIES) {
                    const delay = INITIAL_DELAY_MS * Math.pow(2, retries);
                    console.warn(`Fetch failed (Attempt ${retries + 1}). Retrying in ${delay / 1000}s...`, error);
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return fetchWithRetry(url, options, retries + 1);
                } else {
                    console.error("Fetch failed after all retries.", error);
                    throw new Error("Failed to fetch data after multiple attempts.");
                }
            }
        }
        
        // --- ⭐️ NEW REPORT TIMELINE FETCHING AND PROCESSING ⭐️ ---

        async function fetchReportTimeline() {
            try {
                const rawData = await fetchWithRetry(REPORT_API_URL, { cache: 'no-cache' });

                if (!Array.isArray(rawData)) {
                    throw new Error('Report API returned non-array data.');
                }

                // Process and sort data (Logic adapted from report.html)
                const parsedData = rawData.map(item => {
                    // Date format is DD/MM/YYYY
                    const [day, month, year] = item.date.split('/');
                    let formattedDate = null;
                    if (day && month && year) {
                        // Create a sortable date string YYYY-MM-DD
                        formattedDate = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                    }

                    return {
                        ...item,
                        sortDate: formattedDate,
                        displayDate: item.date || 'N/A' // e.g., "01/10/2025"
                    };
                });

                // Filter out items without a valid date, sort descending, and take the latest 30
                timelineReports = parsedData
                    .filter(item => item.sortDate)
                    .sort((a, b) => new Date(b.sortDate) - new Date(a.sortDate));

                console.log(`[Chatbot] Fetched ${timelineReports.length} timeline reports.`);
            } catch (error) {
                console.error("Failed to fetch timeline reports:", error);
                // Set to empty array on failure
                timelineReports = []; 
            }
        }
        
        // --- Report Flow Functions (Adapted from report.html) ---

        // Utility for creating a clean summary of a single date's reports
        function generateDateSummary(date) {
            const reports = timelineReports.filter(item => item.displayDate === date);

            if (reports.length === 0) {
                return `Sorry, no reports were found for **${date}**.`; // English
            }

            let reportsContent = '';
            
            const reportsByZone = reports.reduce((acc, item) => {
                const zone = item.zone || 'Unknown Zone'; // English
                if (!acc[zone]) {
                    acc[zone] = [];
                }
                
                // ⭐️ NEW: Create HTML for the report item including a clickable thumbnail ⭐️
                let imageHtml = '';
                if (item.image && item.image !== 'N/A' && item.image.startsWith('http')) {
                    imageHtml = `
                        <a href="${item.image}" target="_blank" title="Click to view image" class="flex-shrink-0 ml-2">
                            <img src="${item.image}" alt="Report Image" class="w-10 h-10 object-cover rounded-md border border-cyan-400 hover:opacity-80 transition duration-150 cursor-pointer" 
                            onerror="this.onerror=null;this.src='https://placehold.co/40x40/4A5568/E2E8F0?text=IMG';">
                        </a>
                    `;
                } else {
                    // Placeholder icon for no image
                    imageHtml = `<span class="flex-shrink-0 ml-2 text-gray-400 text-xl" title="No Image"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd" /></svg></span>`;
                }

                // Ensure detail text is clean and use a structured div for layout
                const detailText = item.detail.replace(/<br>/g, ' ').replace(/\n/g, ' ');

                acc[zone].push(`
                    <div class="flex items-center justify-between p-2 my-1 border-b border-gray-700/50 last:border-b-0">
                        <span class="flex-1 text-gray-300 pr-2 leading-tight">
                            ${detailText} 
                            <span class="text-xs text-gray-400 block mt-0.5">Posted by: ${item.postby || 'System'}</span>
                        </span>
                        ${imageHtml}
                    </div>
                `);
                // ⭐️ END NEW IMAGE HTML ⭐️
                return acc;
            }, {});

            
            for (const zone in reportsByZone) {
                reportsContent += `<strong class="text-cyan-400 mt-3 block">[Zone: ${zone}]</strong>`;
                // Reports are now joined directly as HTML divs
                reportsContent += `<div class="mt-1 border border-gray-700/50 rounded-lg overflow-hidden">${reportsByZone[zone].join('')}</div>`;
            }

            let summaryHtml = `
                <span class="text-lg font-bold">Summary Report for ${date} (${reports.length} items):</span>
                ${reportsContent}
                <p class="mt-4 text-sm text-gray-400">Is there anything else I can help summarize or search for? Or type <strong>'Back'</strong> to select a new date.</p>
            `;

            return summaryHtml; 
        }

        // Action function to show unique date options (10 latest days)
        function showReportDateOptions() {
            isInReportFlow = true; // Set state
            
            if (timelineReports.length === 0) {
                 const message = "Report data is currently loading, or there was an error fetching the data. Please try again later, or type 'Back' to cancel."; // English
                 mainAddMessage("Bot", message.replace(/\n/g, '<br>'), true);
                 return;
            }
            
            // Get unique dates from the timeline data (sorted by fetchReportTimeline)
            const uniqueDates = Array.from(new Set(timelineReports.map(item => item.displayDate)));
            
            if (uniqueDates.length === 0) {
                 const message = "Sorry, no report dates were found in the system."; // English
                 mainAddMessage("Bot", message.replace(/\n/g, '<br>'), true);
                 return;
            }

            // Create option parts (limit to 10 latest dates)
            const dateOptionsHTML = uniqueDates.slice(0, 10).map(date => {
                // Return a button element string
                return `<button onclick="handleReportOptionClick('ShowSummary','${date}')" class="chat-option-button">${date}</button>`;
            }).join('');
            
            const messageText = "Do you want to see the Operational Timeline Report? Please select the date you wish to view (showing the latest 10 days):"; // English
            
            const fullResponse = `
                ${messageText}<br>
                <div class="chat-option-container mt-3">
                    ${dateOptionsHTML}
                    <button onclick="handleReportOptionClick('Back')" class="chat-option-button bg-gray-600 hover:bg-gray-500 text-white">Back (Cancel)</button>
                </div>
            `;
            
            mainAddMessage("Bot", fullResponse, true);
        }
        window.showReportDateOptions = showReportDateOptions;

        // Action function to show the actual report summary
        function showReportSummary(date) {
            const summaryText = generateDateSummary(date);
            
            const fullResponse = `${summaryText}
                <div class="chat-option-container mt-3">
                    <button onclick="handleReportOptionClick('ShowOptions')" class="chat-option-button bg-gray-600 hover:bg-gray-500 text-white">Back to Date Selection</button>
                    <button onclick="handleReportOptionClick('Back')" class="chat-option-button bg-gray-600 hover:bg-gray-500 text-white">Cancel</button>
                </div>
            `;
            mainAddMessage("Bot", fullResponse, true);
        }
        window.showReportSummary = showReportSummary;
        
        // Unified Handler for Report Flow Clicks
        function handleReportOptionClick(actionType, date = null) {
             let userMessage = '';
             let nextAction = null;
             
             switch (actionType) {
                 case 'InitialPrompt':
                     userMessage = 'Yes, I want to see the Timeline Report.'; // English
                     nextAction = () => showReportDateOptions();
                     break;
                 case 'ShowSummary':
                     userMessage = `Selected date ${date}`; // English
                     nextAction = () => showReportSummary(date);
                     break;
                 case 'ShowOptions':
                      userMessage = 'Back to Date Selection'; // English
                      nextAction = () => showReportDateOptions();
                      break;
                 case 'Back':
                     userMessage = 'Back (Cancel)'; // English
                     nextAction = () => {
                         isInReportFlow = false;
                         mainAddMessage("Bot", "Report mode canceled. How else can I assist you?", true); // English
                     };
                     break;
                 default:
                     return;
             }
             
             // 1. Add user message
             mainAddMessage("You", userMessage, false);
             // 2. Execute next action
             nextAction();
             // 3. Clear input just in case
             document.getElementById("main-user-input").value = '';
             autoResizeTextarea(document.getElementById("main-user-input"));
        }
        window.handleReportOptionClick = handleReportOptionClick;
        
        // --- Data Processing Logic (Group by Plant) (kept from original) ---

        function processData(rawData) {
            let dataArray = rawData;
            if (typeof rawData === 'object' && rawData !== null && Array.isArray(rawData.data)) {
                dataArray = rawData.data;
            }

            if (!dataArray || !Array.isArray(dataArray) || dataArray.length === 0) {
                return { plants: [], inProcess: [], completed: [] };
            }

            const firstObject = dataArray[0];
            if (typeof firstObject !== 'object' || firstObject === null) {
                throw new Error("Invalid data structure received. Expected array of objects.");
            }
            
            const plantKey = 'Plant';
            const statusKey = 'Status';

            if (!Object.prototype.hasOwnProperty.call(firstObject, plantKey) || 
                !Object.prototype.hasOwnProperty.call(firstObject, statusKey)) {
                   throw new Error("Missing required data columns ('Plant' or 'Status') in JSON object keys.");
            }

            const plantStatusCounts = {};

            dataArray.forEach(rowObject => {
                const plant = rowObject[plantKey];
                const status = rowObject[statusKey];

                if (!plant || typeof plant !== 'string' || plant.trim() === '') {
                    return;
                }

                if (!plantStatusCounts[plant]) {
                    plantStatusCounts[plant] = { 'In process': 0, 'Completed': 0 };
                }

                if (status === 'In process') {
                    plantStatusCounts[plant]['In process']++;
                } else if (status === 'Completed') {
                    plantStatusCounts[plant]['Completed']++;
                }
            });

            const plants = Object.keys(plantStatusCounts);
            const inProcess = plants.map(plant => plantStatusCounts[plant]['In process']);
            const completed = plants.map(plant => plantStatusCounts[plant]['Completed']);
            
            // Reset min-width for vertical chart
            const chartCanvas = document.getElementById('workStatusChart');
            chartCanvas.style.minWidth = `100%`;

            return { plants, inProcess, completed };
        }
        
        // --- Chart Rendering Logic (kept from original) ---

        function renderChart(data) {
            const chartCanvas = document.getElementById('workStatusChart');
            const chartCard = chartCanvas.closest('.dashboard-card');

            if (data.plants.length === 0) {
                chartCanvas.style.display = 'none';
                
                const noDataMessage = document.createElement('p');
                noDataMessage.textContent = 'No task data found for the required statuses (In process or Completed).';
                noDataMessage.className = 'text-center text-lg text-gray-400 py-4';
                
                const container = chartCanvas.closest('.chart-container') || chartCanvas.parentElement;
                container.innerHTML = '';
                container.appendChild(noDataMessage);
                return;
            }

            // Destroy previous chart instance if it exists to prevent overlap
            if (window.myChartInstance) {
                window.myChartInstance.destroy();
            }

            const ctx = chartCanvas.getContext('2d');
            
            window.myChartInstance = new Chart(ctx, {
                type: 'bar', // Vertical Bar Chart
                data: {
                    labels: data.plants, // X-axis: Plant
                    datasets: [
                        {
                            label: 'In Process',
                            data: data.inProcess, // Y-axis: In Process Count
                            backgroundColor: 'rgba(0, 255, 255, 0.9)', 
                            borderColor: '#00FFFF', 
                            borderWidth: 2,
                            borderRadius: 6, 
                            borderSkipped: false, 
                            hoverBackgroundColor: 'rgba(0, 255, 255, 1.0)',
                            hoverBorderColor: '#FFFFFF',
                            barThickness: 18, 
                            categoryPercentage: 0.8,
                            barPercentage: 0.9,
                        },
                        {
                            label: 'Completed',
                            data: data.completed, // Y-axis: Completed Count
                            backgroundColor: 'rgba(16, 185, 129, 0.9)', 
                            borderColor: '#10B981', 
                            borderWidth: 2,
                            borderRadius: 6, 
                            borderSkipped: false, 
                            hoverBackgroundColor: 'rgba(16, 185, 129, 1.0)',
                            hoverBorderColor: '#FFFFFF',
                            barThickness: 18, 
                            categoryPercentage: 0.8,
                            barPercentage: 0.9,
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false, 
                    plugins: {
                        legend: {
                            labels: {
                                color: '#E2E8F0',
                                font: {
                                    size: 10 
                                },
                                boxWidth: 10, 
                            }
                        },
                        title: {
                            display: true,
                            text: 'Status Work Issue by Plant',
                            color: '#00FFFF',
                            font: {
                                size: 14, 
                                weight: 'bold'
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(255, 255, 255, 0.95)', 
                            titleColor: '#1A202C',
                            bodyColor: '#1A202C',
                            borderColor: '#00FFFF',
                            borderWidth: 1,
                            cornerRadius: 6,
                            padding: 8, 
                        },
                        datalabels: { 
                            align: 'end', 
                            anchor: 'end',
                            offset: 2, 
                            color: '#E2E8F0', 
                            font: {
                                size: 10 
                            },
                            formatter: function(value, context) {
                                return value > 0 ? value : ''; 
                            }
                        }
                    },
                    scales: {
                        x: {
                            stacked: false, 
                            ticks: {
                                color: '#A0AEC0',
                                font: {
                                    weight: 'bold',
                                    size: 8 
                            }
                            },
                            grid: {
                                display: false 
                            },
                            title: {
                                display: true,
                                text: 'Plant (X-Axis)',
                                color: '#E2E8F0',
                                font: {
                                    weight: 'bold',
                                    size: 10 
                                }
                            }
                        },
                        y: {
                            stacked: false,
                            beginAtZero: true,
                            ticks: {
                                color: '#A0AEC0', 
                                precision: 0,
                                size: 8 
                            },
                            grid: {
                                color: 'rgba(74, 85, 104, 0.2)'
                            },
                            title: {
                                display: true,
                                text: 'Tasks Count (Y-Axis)',
                                color: '#E2E8F0',
                                font: {
                                    weight: 'bold',
                                    size: 10 
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // ⭐️ NEW FUNCTION: Typing Simulation for Conversational Feel ⭐️
        function typeMessage(elementId, fullText, delay = 20) {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            let charIndex = 0;
            element.innerHTML = ''; // Clear placeholder text

            function type() {
                if (charIndex < fullText.length) {
                    // Check for HTML tags to skip typing animation over them (e.g., <div>, <strong>)
                    const char = fullText.charAt(charIndex);
                    if (char === '<') {
                        const tagEnd = fullText.indexOf('>', charIndex);
                        if (tagEnd !== -1) {
                            element.innerHTML += fullText.substring(charIndex, tagEnd + 1);
                            charIndex = tagEnd + 1;
                        } else {
                            // If tag is somehow malformed, just print the character
                            element.innerHTML += char;
                            charIndex++;
                        }
                    } else {
                        element.innerHTML += char;
                        charIndex++;
                    }
                    
                    // Scroll to bottom periodically to follow text
                    if (charIndex % 10 === 0) {
                         window.scrollTo(0, document.body.scrollHeight);
                    }
                    
                    // Add a typing indicator class if not present
                    if (!element.classList.contains('typing-indicator')) {
                         element.classList.add('typing-indicator');
                    }

                    setTimeout(type, delay);
                } else {
                    // Remove typing indicator class when done
                    element.classList.remove('typing-indicator');
                     window.scrollTo(0, document.body.scrollHeight);
                }
            }
            type();
        }
        window.typeMessage = typeMessage; 

        // --- VDM Search Assistant Logic (kept from original) ---

        // Function to handle the chat log expansion/message display
        // Modified to return the unique ID for typing/replacement
        function mainAddMessage(sender, message, isBot = false, messageId = null) {
            const chatLog = document.getElementById("main-chat-log");
            const messageElement = document.createElement("div");

            const justification = isBot ? 'justify-start' : 'justify-end';
            const margin = isBot ? 'mr-auto' : 'ml-auto'; 
            const bgColor = isBot ? 'bg-gray-600 text-gray-200 bot-message' : 'bg-cyan-700 text-white user-message';
            
            // Generate a unique ID if one is not provided, especially for bot messages
            const uniqueId = messageId || `msg-${Date.now()}-${Math.floor(Math.random() * 1000)}`;

            messageElement.className = `block w-full flex ${justification}`;
            
            const content = document.createElement('div');
            content.id = uniqueId; // Set the ID here
            content.innerHTML = message; 

            // Max width adjusted for full screen chat 
            content.className = `max-w-full md:max-w-[70%] p-3 rounded-xl mb-2 shadow-md text-sm transition-all duration-300 ${bgColor} ${margin}`;
            
            messageElement.appendChild(content);
            chatLog.appendChild(messageElement);
            
            // ⭐️ After first user message, transition to active state ⭐️
            if (chatLog.children.length === 1 && isBot === false) { 
                forceToActiveState();
            }

            // ⭐️ KEY FIX: Scroll the main window to the bottom to follow the new content ⭐️
            window.scrollTo(0, document.body.scrollHeight);
            
            return uniqueId;
        }

        // Utility for similarity calculation
        function tokenize(text) {
            return text.toLowerCase().replace(/[^\w\s]/gi, '').trim().split(/\s+/).filter(word => word.length > 2);
        }

        function calculateSimilarity(str1, str2) {
            const words1 = tokenize(str1);
            const words2 = tokenize(str2);
            if (words1.length === 0 || words2.length === 0) return 0;

            const set1 = new Set(words1);
            const intersection = words2.filter(word => set1.has(word));
            const union = new Set([...words1, ...words2]);
            
            return intersection.length / union.size;
        }

        function findSolutionMatch(userInput) {
            const contextText = userInput;

            const matches = solutions
                .map(item => {
                    const combinedText = `${item.topic} ${item.topic} ${item.detail}`;
                    return {
                        ...item,
                        similarity: calculateSimilarity(contextText, combinedText)
                    };
                })
                .sort((a, b) => b.similarity - a.similarity);

            // Return the top 3 matches
            return matches.slice(0, 3);
        }

        async function fetchSolutionsForChat() {
            try {
                const data = await fetchWithRetry(SOLUTIONS_API_URL, { cache: 'no-cache' }); 
                solutions = data;
                console.log(`[Chatbot] Fetched ${solutions.length} solutions for search assistant.`);
            } catch (error) {
                // Not using mainAddMessage here to avoid cluttering chat on startup failure
                console.error("Failed to fetch solutions for chat:", error);
            }
        }

        // ⭐️ MODIFIED mainSendMessage FUNCTION ⭐️
        async function mainSendMessage() {
            const userInputElement = document.getElementById("main-user-input");
            let message = userInputElement.value.trim();

            if (message === "") return;
            
            // 1. Add user message and clear input
            mainAddMessage("You", message, false);
            userInputElement.value = "";
             // Reset textarea height
            autoResizeTextarea(userInputElement);
            
            // --- ⭐️ NEW REPORT KEYWORD CHECK ⭐️ ---
            const normalizedMessage = message.toLowerCase();
            const isReportQuery = REPORT_KEYWORDS.some(keyword => normalizedMessage.includes(keyword));
            const isBack = normalizedMessage.includes('back') || normalizedMessage.includes('ย้อนกลับ') || normalizedMessage.includes('cancel');
            
            if (isBack) {
                 handleReportOptionClick('Back');
                 return;
            }
            
            if (isReportQuery && !isInReportFlow) {
                // If it's a report query and we are NOT already in the report flow, show initial prompt
                const responseHtml = `
                    Do you want to see the Operational Timeline Report?<br>
                    <div class="chat-option-container mt-3">
                        <button onclick="handleReportOptionClick('InitialPrompt')" class="chat-option-button">Yes, show report</button>
                    </div>
                `;
                mainAddMessage("Bot", responseHtml, true);
                return;
            }
            // --- ⭐️ END REPORT KEYWORD CHECK ⭐️ ---


            if (solutions.length === 0) {
                mainAddMessage("Bot", "Solution data is still loading or failed to load. Please wait a moment and try again.", true);
                return;
            }


            // Show a minimal searching indicator 
            const placeholderText = 'Searching...';
            // Add a temporary message container with typing indicator
            const tempIndicatorId = mainAddMessage("Bot", `<span class="typing-indicator">${placeholderText}</span>`, true); 
            
            // 2. Perform search - always gets the top 3 matches
            const relevantSolutions = findSolutionMatch(message);

            // Simulate network delay to make the typing effect noticeable (0.8 seconds)
            await new Promise(resolve => setTimeout(resolve, 800));

            // 3. Construct the detailed response
            let botResponseHTML = ""; // New variable for immediate HTML insertion
            const textToType = []; // Array of { id: 'uniqueId', text: 'fullText' }
            
            const bestSimilarity = relevantSolutions.length > 0 ? relevantSolutions[0].similarity : 0;
            
            if (relevantSolutions.length > 0) {
                
                const listItems = relevantSolutions.map((sol, index) => {
                    const uniqueTextId = `typed-sol-${tempIndicatorId}-${index}`; // Unique ID for the p tag content
                    const solutionHeader = `💡 Solution ${index + 1}: ${sol.topic}`;
                    
                    textToType.push({ id: uniqueTextId, text: sol.detail }); // Queue the text for typing

                    // ⭐️ NEW IMAGE THUMBNAIL LOGIC for Solutions ⭐️
                    let imageHtml = '';
                    if (sol.image && sol.image !== 'N/A' && sol.image.startsWith('http')) {
                        imageHtml = `
                            <a href="${sol.image}" target="_blank" title="Click to view image" class="flex-shrink-0 ml-3">
                                <img src="${sol.image}" alt="Solution Image" class="w-10 h-10 object-cover rounded-md border border-cyan-400 hover:opacity-80 transition duration-150 cursor-pointer" 
                                onerror="this.onerror=null;this.src='https://placehold.co/40x40/4A5568/E2E8F0?text=IMG';">
                            </a>
                        `;
                    } else {
                        imageHtml = `<span class="flex-shrink-0 ml-3 text-gray-400 text-xl" title="No Image"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd" /></svg></span>`;
                    }
                    // ⭐️ END NEW IMAGE THUMBNAIL LOGIC ⭐️

                    // Return the HTML structure with an empty <p> tag that has a unique ID
                    return `<div class="p-3 mt-3 rounded-xl border border-cyan-600 bg-gray-700 text-white shadow-md">
                                <div class="flex justify-between items-center mb-1">
                                    <strong class="text-cyan-400 text-base flex-1">${solutionHeader}</strong>
                                    ${imageHtml}
                                </div>
                                <p id="${uniqueTextId}" class="mt-2 whitespace-pre-wrap text-sm leading-relaxed typing-indicator-placeholder"></p>
                            </div>`;
                }).join('');

                let introText;
                if (bestSimilarity >= 0.3) {
                    introText = `Based on your query, here are the 3 most relevant solutions:`;
                } else if (bestSimilarity > 0) {
                     introText = `Related solutions were found, but accuracy is low. Here are the 3 closest solutions:`;
                } else {
                    introText = `No direct solutions were found for your query in the database. However, we present 3 general related solutions as the best current matches:`;
                }

                const footerText = `You can try using other keywords for a more precise search.`;

                // Combine structural HTML
                botResponseHTML = `${introText}<br>${listItems}<br><br><em class="text-xs text-gray-400">${footerText}</em>`;

            } else {
                botResponseHTML = "Error processing search results. Please try again or check the database source.";
            }

            // 4. Replace temporary message with structural HTML immediately
            const tempElement = document.getElementById(tempIndicatorId);
            if (tempElement && tempElement.parentElement) {
                // We are replacing the content of the DIV that holds the message.
                tempElement.innerHTML = botResponseHTML; 
            }

            // 5. Start typing for each dynamic text element sequentially
            if (textToType.length > 0) {
                for (const item of textToType) {
                    // Wait for a small moment between typing each solution title for better conversational flow
                    // We only need to wait if it's not the first item
                    if (textToType.indexOf(item) !== 0) {
                       await new Promise(resolve => setTimeout(resolve, 300));
                    }
                    // Start typing the detail text into the pre-created <p> tag
                    await typeMessage(item.id, item.text, 20);
                }
            }
        }
        window.mainSendMessage = mainSendMessage; 
        

        // --- Execution Function (kept from original) ---

        async function initDashboard() {
            const loadingElement = document.getElementById('loading');
            const errorElement = document.getElementById('error-message');

            loadingElement.classList.remove('hidden');
            errorElement.classList.add('hidden');

            try {
                // Fetch data from the GAS API (Chart Data)
                const rawData = await fetchWithRetry(GAS_API_URL, { cache: 'no-cache' }); 
                
                // Process the raw data into chart-ready format
                const chartData = processData(rawData);

                // Render the chart
                renderChart(chartData);
                
            } catch (error) {
                console.error("Failed to initialize dashboard:", error);
                const errorDetails = document.getElementById('error-message');
                errorDetails.textContent = `Error fetching data: ${error.message}`;
                errorElement.classList.remove('hidden');
            } finally {
                loadingElement.classList.add('hidden');
            }
        }

        // --- Toggle Chart Visibility Function (kept from original) ---
        function toggleChart() {
            const content = document.getElementById('chartSection'); // Target the wrapper div now
            
            // Toggle visibility classes for the popover
            content.classList.toggle('popover-hidden');
            content.classList.toggle('popover-visible');
            
            // ⭐️ FIX: Toggle the 'hidden' class based on 'popover-hidden' status ⭐️
            if (content.classList.contains('popover-hidden')) {
                // Wait for the transition (300ms) before hiding completely
                setTimeout(() => content.classList.add('hidden'), 300);
            } else {
                // Show immediately before transition starts
                content.classList.remove('hidden');
            }
        }
        window.toggleChart = toggleChart; 

        // Start the process when the window loads
        window.onload = function() {
            initDashboard(); // For Chart
            fetchSolutionsForChat(); // For VDM Search Assistant (Solutions API)
            fetchReportTimeline(); // ⭐️ NEW: Fetch Report Timeline Data ⭐️
            
            // Add click listener to close popover when clicking outside
            document.addEventListener('click', (event) => {
                const popup = document.getElementById('chartSection');
                const button = document.getElementById('statusChartButton');
                
                // Check if the click is outside the popup and outside the button, AND the popup is currently visible
                if (popup && button && 
                    !popup.contains(event.target) && 
                    !button.contains(event.target) && 
                    popup.classList.contains('popover-visible')) {
                    
                    toggleChart();
                }
            });
        };

    </script>
    
    <!-- Google Translate Script (MUST be loaded at the end of the body) -->
    <script type="text/javascript" src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>

</body>
</html>
