<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VDM Solutions Platform</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter as the default font, common in modern designs -->
    <style>
        /* --- AI THEME STYLES (Space/Neon Cyan Dark Theme) --- */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1A202C; /* Deep Space Blue/Black background */
            color: #E2E8F0; /* Light text for contrast */
        }
        /* Header and Accent Color */
        .header-bg {
            background-color: #2D3748; /* Slightly lighter dark background for header */
            border-bottom: 3px solid #00FFFF; /* Neon Cyan line */
        }
        .header-text {
            color: #00FFFF; /* Neon Cyan Text */
            font-family: 'Inter', sans-serif;
            letter-spacing: 2px;
            /* Base shadow for the neon look */
            text-shadow: 0 0 5px rgba(0, 255, 255, 0.4); 
        }

        /* New Animation for Header - AI Pulse Glow */
        @keyframes subtle-pulse {
            0%, 100% {
                text-shadow: 0 0 5px rgba(0, 255, 255, 0.4), 0 0 10px rgba(0, 255, 255, 0.2);
            }
            50% {
                text-shadow: 0 0 10px rgba(0, 255, 255, 0.6), 0 0 20px rgba(0, 255, 255, 0.4);
            }
        }
        .header-text-glow {
            animation: subtle-pulse 3s infinite ease-in-out;
        }

        /* AI Spinner / Loading Animation (Siri/AI Themed) */
        .ai-spinner {
            width: 80px;
            height: 80px;
            border: 5px solid rgba(0, 255, 255, 0.2);
            border-top-color: #00FFFF; /* Neon Cyan */
            border-radius: 50%;
            animation: spin 1s linear infinite;
            position: relative;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.6);
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Search/Filter Card Container */
        .search-card {
            background-color: #2D3748; /* Dark Card Background */
            border: 1px solid #4A5568; 
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4); /* Deeper shadow */
        }
        .search-input {
             /* Dark input background, neon border */
            background-color: #1A202C;
            color: #E2E8F0;
            border-color: #00FFFF; /* Neon Cyan border */
            transition: all 0.2s;
        }
        .search-label {
            color: #00FFFF; /* Neon Cyan for labels */
            font-weight: 600;
        }
        /* Enhanced Focus/Glow Effect for Inputs */
        .search-input:focus {
            border-color: #00FFFF;
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.8), inset 0 0 5px rgba(0, 255, 255, 0.3); /* Stronger glow and inner shadow */
            transform: scale(1.01);
        }

        /* Solution Card */
        .solution {
            background-color: #2D3748; /* Dark Card */
            border: 1px solid #4A5568;
            color: #E2E8F0;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.2);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        /* Enhanced hover effect for cards */
        .solution:hover {
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.4); /* Stronger glow shadow */
            border-color: #00FFFF; /* Neon Cyan border on hover */
            transform: translateY(-4px) scale(1.01); 
        }
        .solution-title {
            color: #00FFFF; /* Neon Cyan Title */
            font-weight: 700;
        }
        
        /* Pagination Buttons */
        .pagination button {
            transition: all 0.2s;
            border-color: #00FFFF !important;
            color: #00FFFF !important;
            background-color: #2D3748 !important; /* Dark background */
        }
        .pagination button.active {
            background-color: #00FFFF !important;
            color: #1A202C !important; /* Dark text on neon */
            font-weight: bold;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.6);
        }
        .pagination button:hover:not(.active) {
            background-color: #384254 !important; /* Slightly lighter dark hover */
            transform: translateY(-1px);
            box-shadow: 0 0 5px rgba(0, 255, 255, 0.4);
        }

        /* Google Translate Styling (Dark Theme Friendly) */
        .translate-dropdown {
            background-color: #1A202C; /* Input background */
            border: 2px solid #00FFFF;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
            transition: all 0.2s;
            /* Ensure the dropdown itself has enough vertical space for easy clicking */
            padding: 0.5rem 0.75rem !important;
            height: 48px !important; 
        }
        .goog-te-combo {
            background-color: #1A202C !important; 
            color: #E2E8F0 !important; /* Light text */
            /* Ensure the select box takes up all available space */
            height: 100% !important; 
            line-height: 1.5rem !important; /* Helps with vertical alignment */
            padding: 0 !important;
            width: 100% !important; /* Enforcing 100% width on the select element */
        }
        .goog-te-gadget-simple {
            border: none !important;
            background: transparent !important;
            line-height: 0 !important;
            padding: 0 !important;
            width: 100% !important;
        }
        .goog-te-gadget-simple * {
            display: none !important;
        }
        .goog-te-combo {
            display: inline-block !important; 
            background-color: #1A202C !important; 
            color: #E2E8F0 !important;
            border: none !important;
            box-shadow: none !important;
            font-size: 1rem !important;
            cursor: pointer;
        }
        .goog-logo-link, .goog-te-banner-frame {
            display: none !important;
        }
        .category-tag {
            color: #1A202C; /* Dark text on colored tag */
            font-weight: 500;
        }
        
        /* --- Chatbot Specific Styles (Space/Neon Theme) --- */
        .chat-container {
            background-color: #2D3748; /* Dark body */
            box-shadow: 0 0 30px rgba(0, 255, 255, 0.2); /* Neon glow shadow on container */
        }
        .chat-header {
            background: linear-gradient(90deg, #00FFFF, #00A3A3); /* Neon Gradient */
            color: #1A202C; /* Dark text on header */
            font-weight: 700;
        }
        .chat-header:hover { opacity: 1; } /* Remove opacity reduction */

        .chat-log {
            background: #1A202C; /* Very Dark Log background */
        }
        /* User Message Bubble */
        .user-message {
            background: #00A3A3; /* Muted Cyan for user */
            color: #1A202C;
            font-weight: 500;
        }
        /* Bot Message Bubble */
        .bot-message {
            background: #4A5568; /* Dark Gray for bot */
            color: #E2E8F0;
            border: 1px solid #00FFFF33;
        }

        /* Refined Chat Input Layout (Adjusted padding for smaller profile) */
        .chat-input {
            background: #2D3748; /* Input bar background */
            padding: 0.65rem; /* Reduced padding from 1rem */
        }
        .chat-input input {
            /* Input field styling */
            background: #1A202C;
            color: #E2E8F0;
            border-color: #00FFFF;
            border-radius: 9999px; 
            padding: 0.5rem 1rem; /* Slightly reduced vertical and horizontal padding */
            flex: 1;
            margin-right: 0.5rem;
            font-size: 0.95rem; /* Slightly smaller font for better fit */
        }
        /* Send button styling (Adjusted padding and icon size in HTML) */
        .chat-input button {
            transition: all 0.2s;
            background: #00FFFF; /* Neon Cyan button */
            color: #1A202C; /* Dark text on neon */
            font-weight: 700;
            border-radius: 9999px;
            padding: 0.5rem 1rem; /* Reduced padding for smaller footprint */
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
            line-height: 1; /* Ensure vertical centering */
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .chat-input button:hover {
            background: #00D0D0;
            transform: translateY(-1px) scale(1.02); /* Less aggressive hover */
            box-shadow: 0 4px 15px rgba(0, 255, 255, 0.8);
        }
        .chat-input button:active {
            transform: translateY(1px) scale(0.95);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.4);
        }

        .hidden { display: none !important; }

        /* FAB Collapsed State Styling */
        .chat-container.h-16.w-16.rounded-full {
            background: #00FFFF;
            box-shadow: 0 0 20px 8px rgba(0, 255, 255, 0.7); /* Stronger Neon Glow */
        }
        .chat-container.h-16.w-16.rounded-full:hover {
            transform: scale(1.1); /* Bigger hover scale */
            box-shadow: 0 0 30px 10px rgba(0, 255, 255, 0.9);
        }
        .chat-container.h-16.w-16.rounded-full:active {
            transform: scale(0.9);
        }
        .chat-container.h-16.w-16.rounded-full .chat-header {
            background: transparent;
        }
        .location-display {
            color: #00FFFF; /* Neon color for location display */
        }

        /* FIX: CSS for allowing the popup content (image) to expand outside its container */
        .popup.expanded {
            overflow: visible !important;
            /* Hides scrollbar on the popup itself, allowing the content to expand */
        }
        .popup-image-zoomed {
            max-width: 150vw !important; /* Allow image to take up 150% of viewport width */
            width: auto !important;
            cursor: zoom-out !important;
            /* Uses a fixed position and moves the image back up/left to center it in the viewport */
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 60; /* Higher than popup (z-50) but lower than overlay (z-40 if it were covering the whole screen) */
            border-radius: 0.75rem; /* Matches the popup's rounded-xl */
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.8);
            transition: all 0.3s ease-in-out;
        }

    </style>
    <!-- Google Analytics Tag -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-SDQG1N4SSV"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());
        gtag('config', 'G-SDQG1N4SSV');
    </script>
</head>

<body class="min-h-screen">
    <!-- Header Section -->
    <header class="header-bg p-6 shadow-md">
        <h1 class="text-4xl font-extrabold text-center header-text tracking-wider uppercase header-text-glow">
            VDM Solutions Platform 
            <!-- Removed Rocket Icon SVG and "2.1 Turbo" text -->
        </h1>
    </header>

    <!-- Main Content Container (Search & Filter) -->
    <div class="p-4 sm:p-6 lg:p-8 solution-list-container">
        <!-- Filter Card -->
        <div class="flex flex-col md:flex-row justify-between items-center search-card p-4 sm:p-6 rounded-xl shadow-lg mb-8 gap-4">
            
            <!-- Search by Topic Group (ADJUSTED to 66.6%) -->
            <div class="w-full md:w-8/12">
                <label for="search" class="block text-sm font-medium search-label mb-2">
                    <!-- Updated Icon: Search -->
                    <svg class="inline-block w-4 h-4 mr-1 align-text-top" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    Search by Topic:
                </label>
                <input type="text" id="search"
                    class="w-full p-3 border-2 search-input rounded-lg focus:ring-transparent transition duration-300 shadow-sm active:scale-[0.99]"
                    placeholder="E.g., printer error, software stuck..."
                    oninput="filterSolutions()" />
            </div>

            <!-- Category Filter Group (REMOVED - Block removed) -->
            <!-- Language Selection Group (ADJUSTED to 33.3%) -->
            <div class="w-full md:w-4/12">
                <label for="language" class="block text-sm font-medium search-label mb-2">
                    <!-- Updated Icon: Globe -->
                    <svg class="inline-block w-4 h-4 mr-1 align-text-top" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m0 0l-7 7-7-7m7 7v10a1 1 0 001 1h3"></path></svg>
                    Select Language:
                </label>
                <!-- Google Translate element integrated and styled below -->
                <!-- Container is now 4/12 for professional layout, height fixed for usability -->
                <div id="google_translate_element" class="translate-dropdown w-full active:scale-[0.99] h-12"></div>
            </div>
        </div>
        
        <!-- AI Loading Indicator -->
        <div id="loading-indicator" class="flex justify-center items-center py-20 hidden">
            <div class="ai-spinner"></div>
        </div>

        <!-- Solutions List -->
        <div id="solutions" class="space-y-4">
            <!-- Solution cards will be inserted here -->
        </div>

        <!-- Pagination Controls -->
        <div class="pagination flex justify-center items-center mt-8 mb-20" id="pagination">
            <!-- Pagination buttons will be inserted here -->
        </div>
    </div>

    <!-- Popup/Modal for Detailed View -->
    <div class="popup-overlay fixed inset-0 bg-gray-900 bg-opacity-75 hidden z-40" id="popupOverlay"
        onclick="closePopup()"></div>
    <div class="popup fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-[95%] max-w-xl bg-gray-700 text-white p-6 rounded-xl shadow-2xl hidden z-50"
        id="popup">
        <img id="popupImage" src="" alt="Solution Image"
            class="w-full h-auto rounded-lg mb-4 cursor-zoom-in transition-all duration-300" onclick="toggleImageSize()">
        <div class="flex justify-between items-start mb-4 border-b pb-2 border-cyan-400">
            <h2 id="popupTopic" class="text-2xl font-bold text-cyan-400 flex-1 pr-4"></h2>
            <!-- Updated Icon: Speaker (TTS) -->
            <button onclick="readPopupText()"
                class="text-3xl p-1 text-gray-400 hover:text-cyan-400 active:scale-90 transition duration-150" title="Read Aloud">
                <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464A4 4 0 0117 12h2.5a.5.5 0 01.5.5v1a.5.5 0 01-.5.5H17a4 4 0 01-1.464 3.536M15 12H9M7 9l-4 3 4 3V9z"></path></svg>
            </button>
        </div>
        <div class="h-64 overflow-y-auto pr-2">
            <p id="popupDetail" class="text-gray-300 leading-relaxed text-base"></p>
        </div>
        <button class="popup-close w-full mt-6 py-2 bg-cyan-500 text-gray-900 font-semibold rounded-lg hover:bg-cyan-400 active:bg-cyan-600 active:scale-[0.99] transition duration-300 shadow-md"
            onclick="closePopup()">
            Close
        </button>
    </div>

    <!-- Floating Chat Container (Re-introduced) -->
    <div class="fixed bottom-4 right-4 z-30" id="chat-wrapper">
        <div class="chat-container w-full max-w-xs h-[500px] bg-white flex flex-col rounded-xl shadow-2xl overflow-hidden transition-all duration-300"
            id="chat-container">
            <!-- Header -->
            <div class="chat-header bg-gradient-to-r from-cyan-500 to-cyan-600 text-white flex items-center justify-between p-4 cursor-pointer text-lg font-semibold shadow-md rounded-t-xl hover:opacity-95 active:scale-[0.99]"
                onclick="collapseChat()">
                <span id="chat-title">VDM Search Assistant</span>
                <!-- The SVG icon will be set via JavaScript -->
                <button id="collapse-btn" class="text-2xl font-bold transition-transform duration-300">
                    <!-- Initial icon set by JS -->
                </button>
            </div>

            <!-- Chat Log -->
            <div class="chat-log flex-1 p-3 overflow-y-auto bg-gray-800" id="chat-log">
                <!-- Messages go here -->
            </div>

            <!-- Chat Input (Refined Layout) -->
            <div class="chat-input flex items-center border-t border-gray-700 bg-gray-800" id="chat-input">
                <input type="text" id="user-input"
                    class="flex-1 border-2 border-cyan-400 rounded-full focus:ring-transparent focus:border-cyan-300 outline-none transition duration-200 shadow-inner bg-gray-900 text-white active:scale-[0.99]"
                    placeholder="Describe your problem..." />
                <button onclick="sendMessage()"
                    class="bg-cyan-500 text-gray-900 font-bold rounded-full hover:bg-cyan-400 active:bg-cyan-600 active:scale-[0.90] transition duration-300 shadow-lg">
                    <!-- Send Icon -->
                    <svg class="w-5 h-5 transform rotate-45 -mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
                </button>
            </div>
        </div>
    </div>


    <script>
        // Data and API configuration
        const apiUrl = "https://script.google.com/macros/s/AKfycbw2lG6q5IjOf9jvZo7y1yGNUn-Y-8XRbG0jEgLCsCX9LZEC96luvk2G3pFPd4QHSUN2Uw/exec";

        let solutions = [];
        let currentPage = 1;
        const itemsPerPage = 10;
        let conversationHistory = []; // Stores conversation context

        // --- Data Fetching and Display ---

        // Mock categories for demonstration (Removed)
        // function mockCategory(index) { ... }
        
        function showLoading() {
            document.getElementById("loading-indicator").classList.remove("hidden");
            document.getElementById("solutions").innerHTML = ""; // Clear old solutions while loading
            document.getElementById("pagination").innerHTML = ""; // Clear pagination while loading
        }

        function hideLoading() {
            document.getElementById("loading-indicator").classList.add("hidden");
        }

        async function fetchSolutions() {
            showLoading(); // <<< SHOW LOADING
            try {
                const response = await fetch(apiUrl);
                const data = await response.json();

                // Assigning data directly without mock categories
                solutions = data;

                currentPage = 1;
                displayFilteredSolutions(solutions);
                displayPagination(solutions);
            } catch (error) {
                console.error("Error fetching solutions:", error);
                // Optionally display an error message in solutions area
                document.getElementById("solutions").innerHTML = '<p class="text-center text-red-500 mt-8">Error loading solutions. Please check the API connection.</p>';
            } finally {
                hideLoading(); // <<< HIDE LOADING
            }
        }

        // Function to populate the category filter dropdown (Removed, placeholder kept)
        function populateCategories(allSolutions) {
            // Function no longer needed 
        }

        function filterSolutions() {
            const searchQuery = document.getElementById("search").value.toLowerCase().trim();

            let filteredSolutions = solutions.filter(item => {
                const passesSearch = item.topic.toLowerCase().includes(searchQuery) ||
                                     item.detail.toLowerCase().includes(searchQuery);

                return passesSearch; // Only filtering by search query now
            });

            currentPage = 1; // **สำคัญ:** รีเซ็ตกลับไปหน้าแรกเสมอเมื่อมีการค้นหา/กรองใหม่
            displayFilteredSolutions(filteredSolutions);
            displayPagination(filteredSolutions);
        }

        // Function to get category color (Removed)
        /*
        function getCategoryColor(category) {
            // ... logic removed
        }
        */

        function displayFilteredSolutions(filteredSolutions) {
            const solutionsContainer = document.getElementById("solutions");
            solutionsContainer.innerHTML = "";
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const items = filteredSolutions.slice(startIndex, endIndex);

            // Use Tailwind classes for card styling
            items.forEach(item => {
                // Category related variables removed

                const solutionElement = document.createElement("div");
                // Added interactive classes for solution cards
                solutionElement.className = "solution flex items-start p-4 rounded-xl shadow-md hover:shadow-lg transition duration-300 cursor-pointer border border-gray-700 hover:border-cyan-400 active:scale-[0.995]";
                solutionElement.onclick = () => openPopup(item);
                solutionElement.innerHTML = `
                    <img src="${item.image || 'https://placehold.co/100x100/1A202C/00FFFF?text=IMG'}" alt="Solution Image" class="w-20 h-20 object-cover rounded-lg mr-4 flex-shrink-0" onerror="this.onerror=null; this.src='https://placehold.co/100x100/1A202C/00FFFF?text=IMG';">
                    <div class="solution-content flex-1 min-w-0">
                        <!-- Category tag display removed -->
                        <h3 class="text-lg font-semibold solution-title truncate mb-1">${item.topic}</h3>
                        <p class="text-sm text-gray-400 line-clamp-2">${item.detail}</p>
                    </div>
                `;
                solutionsContainer.appendChild(solutionElement);
            });
        }

        function displayPagination(filteredSolutions) {
            const paginationContainer = document.getElementById("pagination");
            paginationContainer.innerHTML = "";
            const totalPages = Math.ceil(filteredSolutions.length / itemsPerPage);

            const navigate = (page) => {
                currentPage = page;
                displayFilteredSolutions(filteredSolutions);
                displayPagination(filteredSolutions);
                // Scroll to top of the solutions list for better UX
                document.getElementById('solutions').scrollIntoView({ behavior: 'smooth' });
            };

            // Previous Button
            if (currentPage > 1) {
                const prevButton = document.createElement("button");
                prevButton.innerText = "Previous";
                // Added interactive classes
                prevButton.className = "px-4 py-2 mx-1 border border-cyan-500 text-cyan-400 rounded-lg hover:bg-cyan-500 hover:text-gray-900 transition duration-200 hover:shadow-md active:scale-95";
                prevButton.onclick = () => navigate(currentPage - 1);
                paginationContainer.appendChild(prevButton);
            }

            // Page Number Buttons (Simplified display logic for space)
            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

            if (endPage - startPage + 1 < maxVisiblePages) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }


            for (let i = startPage; i <= endPage; i++) {
                const pageButton = document.createElement("button");
                pageButton.innerText = i;
                // Added interactive classes
                pageButton.className = `px-4 py-2 mx-1 border rounded-lg transition duration-200 hover:shadow-md active:scale-95 ${i === currentPage ? 'bg-cyan-500 text-gray-900 font-bold border-cyan-500 shadow-md' : 'bg-gray-700 text-cyan-400 border-gray-600 hover:bg-gray-600'}`;
                pageButton.onclick = () => navigate(i);
                paginationContainer.appendChild(pageButton);
            }

            // Next Button
            if (currentPage < totalPages) {
                const nextButton = document.createElement("button");
                nextButton.innerText = "Next";
                // Added interactive classes
                nextButton.className = "px-4 py-2 mx-1 border border-cyan-500 text-cyan-400 rounded-lg hover:bg-cyan-500 hover:text-gray-900 transition duration-200 hover:shadow-md active:scale-95";
                nextButton.onclick = () => navigate(currentPage + 1);
                paginationContainer.appendChild(nextButton);
            }
        }

        // --- Popup/Modal Logic ---

        function openPopup(item) {
            const popup = document.getElementById("popup");
            const img = document.getElementById("popupImage");
            
            img.src = item.image || 'https://placehold.co/600x400/1A202C/00FFFF?text=NO+IMAGE';
            document.getElementById("popupTopic").innerText = item.topic;
            document.getElementById("popupDetail").innerText = item.detail;
            document.getElementById("popup").classList.remove("hidden");
            document.getElementById("popupOverlay").classList.remove("hidden");
            
            // Initial state reset
            popup.classList.remove('expanded');
            img.classList.remove("cursor-zoom-out", "popup-image-zoomed");
            img.classList.add("cursor-zoom-in");
            img.style.maxWidth = '100%';
            img.style.width = '100%'; 
        }

        function closePopup() {
            document.getElementById("popup").classList.add("hidden");
            document.getElementById("popupOverlay").classList.add("hidden");
            speechSynthesis.cancel(); // Stop reading when closing popup
        }

        function toggleImageSize() {
            const img = document.getElementById("popupImage");
            const popup = document.getElementById("popup");
            
            if (img.classList.contains('cursor-zoom-in')) {
                // EXPAND / Zoom Out
                img.classList.remove("cursor-zoom-in");
                img.classList.add("cursor-zoom-out", "popup-image-zoomed"); // Add custom class for zoom style
                popup.classList.add('expanded'); // Allow overflow
                
                // Set width to a fixed large size relative to viewport for expansion effect
                img.style.width = '150vw'; 
                img.style.maxWidth = '150vw'; 

            } else {
                // COLLAPSE / Zoom In (Fit to popup)
                img.classList.remove("cursor-zoom-out", "popup-image-zoomed");
                img.classList.add("cursor-zoom-in");
                popup.classList.remove('expanded'); // Disallow overflow
                
                // Reset width to fit container
                img.style.width = '100%'; 
                img.style.maxWidth = '100%'; 
            }
        }

        // --- Google Translate Integration ---

        function googleTranslateElementInit() {
            new google.translate.TranslateElement({ pageLanguage: 'en' }, 'google_translate_element');
        }

        // --- Text-to-Speech (TTS) Logic ---

        function getSelectedLanguage() {
            const langCodeElement = document.querySelector('.goog-te-combo');
            const selectedLang = langCodeElement ? langCodeElement.value : 'en';

            const langMap = {
                'zh-CN': 'zh-CN', 'zh-TW': 'zh-TW', 'th': 'th-TH', 'ja': 'ja-JP',
                'ko': 'ko-KR', 'vi': 'vi-VN', 'km': 'km-KH', 'my': 'my-MM',
                'fil': 'fil-PH', 'en': 'en-US', 'fr': 'fr-FR', 'es': 'es-ES'
            };
            return langMap[selectedLang] || 'en-US';
        }

        function readAloud(text) {
            if (speechSynthesis.speaking) {
                speechSynthesis.cancel();
            }

            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = getSelectedLanguage();

            const voices = speechSynthesis.getVoices();
            const preferredVoice = voices.find(voice => voice.lang === utterance.lang) || voices[0];
            if (preferredVoice) {
                utterance.voice = preferredVoice;
            }

            speechSynthesis.speak(utterance);
        }

        function readPopupText() {
            const topic = document.getElementById("popupTopic").innerText;
            const detail = document.getElementById("popupDetail").innerText;
            const textToRead = `Topic: ${topic}. Details: ${detail}`;
            readAloud(textToRead);
        }

        // --- Chatbot Logic (Re-implemented for Similarity Search) ---
        
        // Define SVG icons for Chatbot toggle
        // ปรับขนาดเป็น w-7 h-7 และสีเป็นสีขาวเพื่อให้ดูสวยงามและชัดเจนขึ้น
        const collapseIconSVG = `<svg class="w-7 h-7" fill="none" stroke="white" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M20 12H4"></path></svg>`; // Minus icon (to close)
        const chatIconSVG = `<svg class="w-7 h-7" fill="none" stroke="white" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-4 4v-4z"></path></svg>`; // Message Square (to open)

        // Collapses/expands the chat window
        function collapseChat() {
            const chatContainer = document.getElementById("chat-container");
            const chatLog = document.getElementById("chat-log");
            const chatInput = document.getElementById("chat-input");
            const collapseBtn = document.getElementById("collapse-btn");
            const chatTitle = document.getElementById("chat-title"); // Get the title span

            // Check if currently expanded (not collapsed)
            const isExpanded = chatContainer.classList.contains("h-[500px]");

            if (!isExpanded) {
                // Expand
                chatContainer.classList.add("h-[500px]", "w-full", "max-w-xs");
                chatContainer.classList.remove("h-16", "w-16", "rounded-full"); 
                chatLog.classList.remove("hidden");
                chatInput.classList.remove("hidden");
                collapseBtn.innerHTML = collapseIconSVG; // Minus icon
                chatTitle.style.display = 'block'; // Show title
            } else {
                // Collapse
                chatContainer.classList.remove("h-[500px]", "w-full", "max-w-xs");
                chatContainer.classList.add("h-16", "w-16", "rounded-full"); 
                chatLog.classList.add("hidden");
                chatInput.classList.add("hidden");
                collapseBtn.innerHTML = chatIconSVG; // Message icon
                chatTitle.style.display = 'none'; // Hide title
            }
        }

        // Add message to chat log
        function addMessage(sender, message, className) {
            const chatLog = document.getElementById("chat-log");
            const messageElement = document.createElement("div");

            const isUser = className === "user-message";
            const bgColor = isUser ? 'bg-cyan-600 text-white' : 'bg-gray-600 text-gray-200'; /* Updated colors */
            const alignment = isUser ? 'self-end' : 'self-start';
            const margin = isUser ? 'ml-auto' : 'mr-auto';

            messageElement.className = `chat-message max-w-[80%] p-3 rounded-xl mb-2 ${bgColor} ${alignment} shadow-md ${margin} text-sm transition-all duration-300`;
            messageElement.innerHTML = message; // Use innerHTML to allow for formatting like <br>

            // Handle touch/press for text-to-speech
            let pressTimer;
            const startPress = () => {
                pressTimer = setTimeout(() => {
                    // Pass only the plain text content for reading aloud
                    createEmojiPopup(messageElement, messageElement.textContent);
                }, 800);
            };
            const endPress = () => clearTimeout(pressTimer);

            messageElement.addEventListener('mousedown', startPress);
            messageElement.addEventListener('mouseup', endPress);
            messageElement.addEventListener('mouseleave', endPress);
            messageElement.addEventListener('touchstart', startPress);
            messageElement.addEventListener('touchend', endPress);
            messageElement.addEventListener('touchcancel', endPress);

            chatLog.appendChild(messageElement);
            chatLog.scrollTop = chatLog.scrollHeight;
        }

        // Function to create the "🔊" emoji pop-up for TTS (kept utility functions)
        function createEmojiPopup(targetElement, text) {
            const existingPopup = document.getElementById('emoji-popup');
            if (existingPopup) existingPopup.remove();

            const popup = document.createElement('div');
            popup.id = 'emoji-popup';
            // Updated popup styling for dark theme
            popup.className = 'fixed bg-gray-700 border border-cyan-500 text-cyan-400 rounded-lg p-2 text-2xl shadow-xl cursor-pointer z-[1001] hover:bg-gray-600 transition';
            popup.textContent = '🔊';

            const rect = targetElement.getBoundingClientRect();
            popup.style.left = `${rect.left + rect.width / 2 - 15}px`;
            popup.style.top = `${rect.top - 40}px`;

            document.body.appendChild(popup);

            popup.addEventListener('click', (e) => {
                e.stopPropagation();
                readAloud(text);
                popup.remove();
            });

            const clickHandler = (e) => {
                if (!popup.contains(e.target) && e.target !== targetElement) {
                    popup.remove();
                    document.removeEventListener('click', clickHandler);
                }
            };
            setTimeout(() => {
                document.addEventListener('click', clickHandler);
            }, 0);
        }
        
        // Function to show Bot typing indicator
        function showTypingIndicator() {
            const chatLog = document.getElementById("chat-log");
            const typingIndicator = document.createElement("div");
            // Updated classes
            typingIndicator.classList.add("max-w-[80%]", "p-3", "rounded-xl", "mb-2", "bg-gray-600", "text-gray-200", "self-start", "shadow-md", "mr-auto", "text-sm", "bot-message");
            typingIndicator.textContent = "Typing...";
            typingIndicator.id = "typing-indicator";
            chatLog.appendChild(typingIndicator);
            chatLog.scrollTop = chatLog.scrollHeight;
        }

        // Function to hide Bot typing indicator
        function hideTypingIndicator() {
            const typingIndicator = document.getElementById("typing-indicator");
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }
        
        // Utility for similarity calculation
        function tokenize(text) {
            // Cleans and splits text into an array of words
            return text.toLowerCase().replace(/[^\w\s]/gi, '').trim().split(/\s+/).filter(word => word.length > 2);
        }

        function calculateSimilarity(str1, str2) {
            // Simple word overlap similarity (Jaccard-like index for words)
            const words1 = tokenize(str1);
            const words2 = tokenize(str2);
            if (words1.length === 0 || words2.length === 0) return 0;

            const set1 = new Set(words1);
            const intersection = words2.filter(word => set1.has(word));
            const union = new Set([...words1, ...words2]);
            
            return intersection.length / union.size;
        }

        function findSolutionMatch(userInput) {
            const fallbackThreshold = 0.1; // If best score is less than this, tone down the recommendation message.
            
            // ใช้เฉพาะข้อความปัจจุบันในการค้นหา (Ignoring conversationHistory)
            const contextText = userInput;

            const matches = solutions
                .map(item => {
                    // Weight the topic more heavily by concatenating it twice
                    const combinedText = `${item.topic} ${item.topic} ${item.detail}`;
                    return {
                        ...item,
                        similarity: calculateSimilarity(contextText, combinedText)
                    };
                })
                // Sort all solutions by similarity (highest first)
                .sort((a, b) => b.similarity - a.similarity);

            // Return top 3 matches regardless of score
            return matches.slice(0, 3);
        }
        
        async function sendMessage() {
            const userInputElement = document.getElementById("user-input");
            let message = userInputElement.value.trim();

            if (message === "") return;

            // 1. Add user message and clear input
            addMessage("You", message, "user-message");
            userInputElement.value = "";

            showTypingIndicator();

            // 2. Perform search
            const relevantSolutions = findSolutionMatch(message);
            let botResponse = "";

            // Check the best score to determine the tone of the response
            const bestSimilarity = relevantSolutions.length > 0 ? relevantSolutions[0].similarity : 0;
            const fallbackThreshold = 0.1; // If best score is less than 10%, treat as general fallback

            if (relevantSolutions.length > 0) {
                // Construct a response with relevant topics and a prompt for action
                const listItems = relevantSolutions.map((sol, index) => {
                    // **MODIFICATION:** Removed similarity percent display
                    return `<div class="p-2 mt-1 rounded-lg border border-cyan-500 bg-gray-700 text-white">
                                <strong>${index + 1}. ${sol.topic}</strong><br>
                                <span class="text-xs text-gray-400">${sol.detail.substring(0, 50)}...</span>
                            </div>`;
                }).join('<br>');

                // Determine the introductory text based on the best match score
                let introText;
                if (bestSimilarity >= fallbackThreshold) {
                    // Good or decent match
                    introText = `Based on your description, here are the top ${relevantSolutions.length} solutions that might help:`;
                } else {
                    // Low match, providing general recommendations instead of saying "no match"
                    introText = `I couldn't find very precise matches, but here are the top ${relevantSolutions.length} generally related solutions:`;
                }


                botResponse = `${introText}<br>${listItems}<br><br>You can search for the full topic name in the Search Bar above, or describe your problem in more detail.`;

            } else {
                // This case should only happen if the solutions array is empty or API failed previously
                botResponse = "I am unable to access the solution database right now. Please check your connection.";
            }

            hideTypingIndicator();
            addMessage("Bot", botResponse, "bot-message");

            // 3. Update history (Ignoring history for search logic as requested)
            // conversationHistory no longer manages chat history for search context
        }

        // Add Enter key listener for sending messages
        document.addEventListener('DOMContentLoaded', () => {
            const inputElement = document.getElementById("user-input");
            if (inputElement) {
                inputElement.addEventListener("keypress", function (e) {
                    if (e.key === "Enter") {
                        sendMessage();
                    }
                });
            }
            // Initial collapse/greeting logic for chatbot
            const chatContainer = document.getElementById("chat-container");
            const chatLog = document.getElementById("chat-log");
            const chatInput = document.getElementById("chat-input");
            const collapseBtn = document.getElementById("collapse-btn");
            const chatTitle = document.getElementById("chat-title"); // Get the title span

            // Initial state: start collapsed
            chatContainer.classList.remove("h-[500px]", "w-full", "max-w-xs");
            chatContainer.classList.add("h-16", "w-16", "rounded-full");
            chatLog.classList.add("hidden");
            chatInput.classList.add("hidden");
            collapseBtn.innerHTML = chatIconSVG; // Message icon
            chatTitle.style.display = 'none'; // Hide title initially
            
            // Add a friendly greeting message once (with slight delay for UI setup)
            setTimeout(() => {
                 addMessage("Bot", "Welcome! Describe your problem (e.g., 'My printer is offline') and I'll find the best solutions for you.", "bot-message");
            }, 500);

        });


        // --- Initial Setup ---

        // Fetch solutions when the page loads
        window.onload = function () {
            fetchSolutions();

            // Geolocation logic (retained)
            if ("geolocation" in navigator) {
                navigator.geolocation.getCurrentPosition(
                    function (position) {
                        const lat = position.coords.latitude;
                        const lon = position.coords.longitude;
                        console.log("🌍 Geolocation retrieved:", lat, lon);

                        // Send to GA
                        gtag('event', 'user_location', {
                            'latitude': lat,
                            'longitude': lon
                        });

                        // Optionally display location (Styled with Tailwind)
                        const locationDisplay = document.createElement("div");
                        locationDisplay.id = "location-display";
                        locationDisplay.className = "text-center text-xs text-cyan-400 mt-2 location-display"; 
                        document.body.prepend(locationDisplay);
                    },
                    function (error) {
                        console.warn("❌ Geolocation access denied or unavailable:", error.message);
                    }
                );
            } else {
                console.warn("Geolocation is not supported by this browser.");
            }
        };
    </script>
    <script type="text/javascript"
        src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>
</body>

</html>
